from openpyxl import Workbook
from openpyxl.styles import Font, Alignment, Border, Side, PatternFill
from openpyxl.chart import BarChart, LineChart, Reference, Series
from openpyxl.utils import get_column_letter
from io import BytesIO

def create_forecast_spreadsheet(products, operating_expenses, cogs_percentage, loan_details, seasonality_factors, company_name, depreciation, interest_expense):
    """
    Creates an Excel spreadsheet with financial forecast and loan amortization data.
    """
    if seasonality_factors is None:
        seasonality_factors = [1.0] * 12

    wb = Workbook()
    wb.remove(wb.active) # Remove the default sheet
    ws_revenue = wb.create_sheet(title="Quarterly Revenue", index=0)
    ws_revenue.title = "Quarterly Revenue"

    # Styles
    header_font = Font(bold=True, color="FFFFFF")
    header_fill = PatternFill(start_color="4F81BD", end_color="4F81BD", fill_type="solid")
    title_font = Font(size=18, bold=True, color="FFFFFF")
    title_fill = PatternFill(start_color="002060", end_color="002060", fill_type="solid") # Dark Blue
    currency_format = '$#,##0.00'

    # Title
    display_company_name = company_name if company_name else 'My Awesome Startup'
    ws_revenue['A1'] = f'Financial Forecast for {display_company_name}'
    ws_revenue['A1'].font = title_font
    ws_revenue['A1'].fill = title_fill
    
    # Create headers: Quarter | Product 1 | Product 2 | ... | Total Revenue
    product_names = [p.get('description', 'N/A') for p in products]
    headers = ['Quarter'] + product_names + ['Total Revenue']
    ws_revenue.append(headers)
    for cell in ws_revenue[2]: # Style header row
        cell.font = header_font
        cell.fill = header_fill

    # Normalize seasonality factors so their sum is 12 (average is 1)
    total_factor = sum(seasonality_factors)
    normalized_factors = [(f / total_factor) * 12 for f in seasonality_factors] if total_factor > 0 else [1.0] * 12

    # Calculate base monthly revenue for each product
    product_monthly_revenues = []
    for product in products:
        price = float(product.get('price', 0) or 0)
        sales_volume = int(product.get('sales_volume', 0) or 0)
        unit = product.get('sales_volume_unit', 'monthly')
        annual_volume = sales_volume * 12 if unit == 'monthly' else sales_volume * 4
        base_monthly_revenue = (price * annual_volume) / 12
        product_monthly_revenues.append(base_monthly_revenue)

    # Populate quarterly data
    for q in range(4): # For Q1, Q2, Q3, Q4
        quarter_data = [f'Q{q+1}']
        quarterly_total_revenue = 0
        
        for prod_idx, base_monthly_rev in enumerate(product_monthly_revenues):
            product_quarterly_revenue = 0
            for month_in_quarter in range(3):
                month_idx = q * 3 + month_in_quarter
                # Revenue for this product for this month
                product_quarterly_revenue += base_monthly_rev * normalized_factors[month_idx]
            
            quarter_data.append(product_quarterly_revenue)
            quarterly_total_revenue += product_quarterly_revenue

        quarter_data.append(quarterly_total_revenue)
        ws_revenue.append(quarter_data)

    # Apply currency formatting to all revenue cells
    for row in ws_revenue.iter_rows(min_row=3, max_row=ws_revenue.max_row, min_col=2, max_col=ws_revenue.max_column):
        for cell in row:
            cell.number_format = currency_format

    # --- Chart for Quarterly Revenue ---
    chart1 = BarChart()
    chart1.type = "col"
    chart1.style = 10
    chart1.grouping = "stacked"
    chart1.title = "Quarterly Revenue by Product"
    chart1.y_axis.title = "Revenue"
    chart1.x_axis.title = "Quarter"
    chart1.y_axis.number_format = currency_format

    data = Reference(ws_revenue, min_col=2, min_row=2, max_col=ws_revenue.max_column - 1, max_row=ws_revenue.max_row)
    cats = Reference(ws_revenue, min_col=1, min_row=3, max_row=ws_revenue.max_row)
    chart1.add_data(data, titles_from_data=True)
    chart1.set_categories(cats)
    chart1.shape = ""
    ws_revenue.add_chart(chart1, "A8")

    # --- Sheet 2: Annual P&L Summary ---
    ws_pnl = wb.create_sheet(title="Annual P&L Summary")
    ws_pnl['A1'] = 'Profit & Loss Summary (USD)'
    ws_pnl['A1'].font = title_font
    ws_pnl['A1'].fill = title_fill
    ws_pnl.merge_cells(start_row=1, start_column=1, end_row=1, end_column=11)

    pnl_headers = [
        'Year', 'Total Revenue', 'COGS', 'Gross Profit', 'Operating Expenses',
        'Net Operating Income', 'Depreciation', 'Earnings Before Tax', 'Taxes',
        'Net Income', 'Debt Service Coverage Ratio'
    ]
    ws_pnl.append(pnl_headers)
    for cell in ws_pnl[2]:
        cell.font = header_font
        cell.fill = header_fill

    # P&L Calculation
    # Year 1 figures
    y1_revenue = sum(product_monthly_revenues) * 12
    y1_opex = 0
    for expense in operating_expenses:
        amount = float(expense.get('amount', 0))
        if expense.get('frequency') == 'monthly':
            y1_opex += amount * 12
        elif expense.get('frequency') == 'quarterly':
            y1_opex += amount * 4

    # Growth assumptions
    revenue_growth_rate = 0.10  # 10%
    opex_growth_rate = 0.05     # 5%

    current_revenue = y1_revenue
    current_opex = y1_opex

    for year in range(1, 6):
        if year > 1:
            current_revenue *= (1 + revenue_growth_rate)
            current_opex *= (1 + opex_growth_rate)

        cogs = current_revenue * (cogs_percentage / 100)
        gross_profit = current_revenue - cogs
        net_operating_income = gross_profit - current_opex
        # EBT calculation in this app seems to be NOI - Depreciation - Interest
        ebt = net_operating_income - depreciation - interest_expense
        
        # Assuming a simple tax rate calculation for projection
        tax_rate_from_loan_calc = 0.25 # A standard assumption for projections
        taxes = max(0, ebt * tax_rate_from_loan_calc)
        net_income = ebt - taxes

        # DSCR Calculation
        total_debt_service = (loan_details.get('monthly_payment', 0) or 0) * 12
        dscr = (net_operating_income / total_debt_service) if total_debt_service > 0 else 0
        
        dscr_display = 'N/A'
        if dscr > 0:
            dscr_display = dscr
        
        row_data = [
            year, current_revenue, cogs, gross_profit, current_opex,
            net_operating_income, depreciation, ebt, taxes, net_income,
            dscr_display
        ]
        ws_pnl.append(row_data)

    # Formatting for P&L sheet
    for row in ws_pnl.iter_rows(min_row=3, max_row=ws_pnl.max_row, min_col=2, max_col=10):
        for cell in row:
            cell.number_format = currency_format
    
    # Format DSCR column
    for cell in ws_pnl['K']:
        if cell.row > 2:
            cell.number_format = '0.00'

    # --- Chart for P&L Summary ---
    chart2 = LineChart()
    chart2.style = 13
    chart2.title = "5-Year Financial Projections"
    chart2.y_axis.title = "Amount (USD)"
    chart2.x_axis.title = "Year"
    chart2.y_axis.number_format = currency_format

    # X-Axis labels (Years)
    labels = Reference(ws_pnl, min_col=1, min_row=3, max_row=ws_pnl.max_row)
    chart2.set_categories(labels)

    # Data series (Total Revenue, Gross Profit, Net Income)
    revenue_series_data = Reference(ws_pnl, min_col=2, min_row=2, max_row=ws_pnl.max_row)
    revenue_series = Series(revenue_series_data, title_from_data=True)

    gprofit_series_data = Reference(ws_pnl, min_col=4, min_row=2, max_row=ws_pnl.max_row)
    gprofit_series = Series(gprofit_series_data, title_from_data=True)

    netincome_series_data = Reference(ws_pnl, min_col=10, min_row=2, max_row=ws_pnl.max_row)
    netincome_series = Series(netincome_series_data, title_from_data=True)

    chart2.series.append(revenue_series)
    chart2.series.append(gprofit_series)
    chart2.series.append(netincome_series)
    ws_pnl.add_chart(chart2, "A10")

    # --- Sheet 3: Loan Payment Schedule ---
    if loan_details and loan_details.get('schedule') is not None:
        ws2 = wb.create_sheet(title="Loan Payment Schedule")

        # Loan Summary
        ws2['A1'] = 'Loan Payment Schedule'
        ws2['A1'].font = title_font
        ws2['A1'].fill = title_fill
        ws2.merge_cells(start_row=1, start_column=1, end_row=1, end_column=2)
        ws2.append(['Loan Amount', loan_details.get('loan_amount')])
        ws2.append(['Annual Interest Rate (%)', loan_details.get('interest_rate')])
        ws2.append(['Loan Term (Years)', loan_details.get('loan_term')])
        ws2.append(['Monthly Payment', loan_details.get('monthly_payment')])
        
        # Apply formatting to summary
        for row_num in range(3, 7): # Adjusted for merged title cell
            ws2[f'B{row_num}'].number_format = currency_format if row_num in [3, 6] else '0.00'

        # Amortization Schedule Headers
        schedule_headers = ['Month', 'Principal Payment', 'Interest Payment', 'Remaining Balance']
        ws2.append([]) # Spacer row
        header_row_num = 8
        ws2.append(schedule_headers)
        for cell in ws2[header_row_num]:
            cell.font = header_font
            cell.fill = header_fill

        # Schedule Data
        for item in loan_details['schedule']:
            ws2.append([
                item['month'],
                item['principal_payment'],
                item['interest_payment'],
                item['remaining_balance']
            ])
        
        # Apply currency formatting to schedule
        for row in ws2.iter_rows(min_row=header_row_num + 1, max_row=ws2.max_row, min_col=2, max_col=4):
            for cell in row:
                cell.number_format = currency_format
        
        # --- Chart for Loan Amortization ---
        chart3 = BarChart()
        chart3.type = "col"
        chart3.style = 10
        chart3.grouping = "stacked"
        chart3.title = "Loan Payments (Principal vs. Interest)"
        chart3.y_axis.title = "Payment Amount"
        chart3.x_axis.title = "Month"
        chart3.y_axis.number_format = currency_format

        # Aggregate data yearly if term is long, otherwise show monthly
        loan_term_years = loan_details.get('loan_term', 0)
        if loan_term_years >= 1:
            # Create a new hidden sheet for yearly chart data
            ws_chart_data = wb.create_sheet(title="LoanChartData")
            ws_chart_data.sheet_state = 'hidden'
            ws_chart_data.append(['Year', 'Principal', 'Interest'])
            yearly_data = {}
            for item in loan_details['schedule']:
                year = (item['month'] - 1) // 12 + 1
                if year not in yearly_data: yearly_data[year] = {'p': 0, 'i': 0}
                yearly_data[year]['p'] += item['principal_payment']
                yearly_data[year]['i'] += item['interest_payment']
            for year, data in sorted(yearly_data.items()):
                ws_chart_data.append([f"Year {year}", data['p'], data['i']])
            
            data_ref = Reference(ws_chart_data, min_col=2, min_row=1, max_col=3, max_row=ws_chart_data.max_row)
            cats_ref = Reference(ws_chart_data, min_col=1, min_row=2, max_row=ws_chart_data.max_row)
            chart3.x_axis.title = "Year"
        else: # Monthly data for short loans
            data_ref = Reference(ws2, min_col=2, min_row=header_row_num, max_col=3, max_row=ws2.max_row)
            cats_ref = Reference(ws2, min_col=1, min_row=header_row_num + 1, max_row=ws2.max_row)

        chart3.add_data(data_ref, titles_from_data=True)
        chart3.set_categories(cats_ref)
        ws2.add_chart(chart3, "F2")

    # Adjust column widths for all sheets
    for sheet in wb.worksheets:
        for col in sheet.columns:
            if not col:
                continue
            max_length = 0
            column_idx = col[0].column
            if column_idx is None:
                continue
            column_letter = get_column_letter(column_idx)
            for cell in col:
                if cell.value:
                    cell_len = len(str(cell.value))
                    if cell_len > max_length:
                        max_length = cell_len
            adjusted_width = (max_length + 2)
            sheet.column_dimensions[column_letter].width = adjusted_width
    
    # Merge the title cell after calculating column widths
    ws_revenue.merge_cells(start_row=1, start_column=1, end_row=1, end_column=ws_revenue.max_column)

    # Save to an in-memory file
    in_memory_file = BytesIO()
    wb.save(in_memory_file)
    in_memory_file.seek(0)
    return in_memory_file